<!DOCTYPE html>
<html>
	<head>
		<link href="../../favicon.ico" rel="shortcut icon" type="image/x-icon"/>      
		<script src="../../lib/jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
		<script src="../../lib/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
		<link href="../../lib/jquery-ui-1.12.1.custom/jquery-ui.css" rel="stylesheet"/>
		<script data-main="../../js/mod/loadtester.js" src="../../lib/require.js"></script>
		<style>
			@font-face { font-family: THNiramitAS; src: url("../../font/THNiramitAS/THNiramitAS.ttf");}
		</style>
	</head>
	<body>
		<video id="Monitor" autoplay playsinline></video>
		<div id="AdXCanvasDiv"></div>
		<button onclick="doStart()">Start</button>
		<button onclick="doStop()">Stop</button>
		<video id="Output" autoplay playsinline></video>
		<button onclick="doShowme()">play show me please</button>
		<div id="Logger"></div>
	</body>
</html>

<script>
	const INT_REC = 1000;
	const uploadUrl = '/openstream/uploadstream';
	let cCmd = 'blank';
	let output;
	let webmstream;	
	let media;

	const mediaSource = new MediaSource();
	mediaSource.addEventListener('sourceopen', handleSourceOpen, false);
	let mediaRecorder;
	let sourceBuffer;

	doInit();

	function doInit(){
		output = document.querySelector("#Output");
		output.oncanplay = function() {
			output.play();
		}

		webmstream = null;	
		media = document.createElement("video");
		media.oncanplay = function() {
			webmstream = media.captureStream();
			console.log(webmstream);
			output.srcObject = webmstream;
		}
	}

	function doStart() {
		let event = new CustomEvent("StartMakeStreamCmd", { "detail": {}});
		document.dispatchEvent(event);
	}

	function doStop() {
		let event = new CustomEvent("StopUploadCmd", { "detail": {cmd: 'close'}});
		document.dispatchEvent(event);
	}

	function doShowme() {
		let msrc = '/openstream/video/videoplayback.mp4';
		//let msrc = '/openstream/video/Big-Bug-Bunny.mp4';
		//let msrc = "/openstream/video/usr/upload/video.webm";
		media.src = msrc;
		media.play();
	}

	function getCCmd(){
		return cCmd;
	}

	document.addEventListener("StreamReady", function(e) {
		$('#Logger').empty();
		let stream = e.detail.stream;
		customRecordStream(stream);
		$('#Logger').append('<p>Start...</p>');
	});

	document.addEventListener("StopUploadCmd", function(e) {
		cCmd = 'close';
		$('#Logger').append('<p>Stop...</p>');
		mediaRecorder = null;
		let event = new CustomEvent("StopMakeStreamCmd", { "detail": {cmd: 'close'}});
		document.dispatchEvent(event);
	});

	function customRecordStream(stream) {
		// should actually check to see if the given mimeType is supported on the browser here.
		//let options = { mimeType: 'video/mp4; codecs=avc1.42E01E, mp4a.40.2' };
		let options = { mimeType: 'video/webm;codecs=vp9' };
		//let options = { mimeType: 'video/webm;codecs=h264' };
		mediaRecorder = new MediaRecorder(stream, options);
		mediaRecorder.ondataavailable = postBlob 
		mediaRecorder.start(INT_REC)
	};

	function postBlob(event){
		if (event.data && event.data.size > 0) {
			sendBlobAsBase64(event.data);
		}
	}

	function handleSourceOpen(event) {
		sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');
		//sourceBuffer = mediaSource.addSourceBuffer('video/webm;codecs=h264"');
	} 

	let countClose = 0;

	function sendBlobAsBase64(blob) {
		const reader = new FileReader();

		reader.addEventListener('load', () => {
			const dataUrl = reader.result;
			const base64EncodedData = dataUrl.split(',')[1];
			console.log(base64EncodedData);
			if (getCCmd() === 'blank'){
				sendDataToBackend(base64EncodedData);
			} else {
				if (countClose===0){
					sendDataToBackend(base64EncodedData);
					countClose++;
				}
			}
		});

		reader.readAsDataURL(blob);
	};

	function sendDataToBackend(base64EncodedData) {
		let cmd = getCCmd();
		console.log(cmd)

		const body = JSON.stringify({ data: base64EncodedData, cmd: cmd });
		fetch(uploadUrl, {
			method: 'POST',
			headers: {
			'Content-Type': 'application/json',
		},
		body
		}).then(res => {
			return res.json()
		}).then(json => console.log(json));
	}; 

				/*
				var newBlob = new Blob([file], {type: type});
				console.log(newBlob);
				var newStreamReadable = newBlob.stream();
				console.log(newStreamReadable);
				
				var reader = newStreamReadable.getReader();

				reader.read().then(({ done, value }) => {
					//if (done) {
						console.log(done);
						console.log("Stream complete");
						console.log(value);
						//localVideo.srcObject = value;
						//return;
					//}			
				});
				console.log(reader.result);
				
				let fileReader = new FileReader();
				fileReader.readAsArrayBuffer(file);
				fileReader.onload = function(ev) {
					const result = ev.target.result;
					console.log(result); // here it is
				}
				*/

				/*
				localVideo.srcObject = null;
				localVideo.src = fileURL;
				*/
				/*
				localStream.getVideoTracks().forEach((track)=>{
					localStream.removeTrack(track);
				});
				if (localStream.getAudioTracks().length > 0){
					localStream.getAudioTracks().forEach((track)=>{
						localStream.removeTrack(track);
					});
				}

				localVideo.oncanplay = function() {
					localVideo.play();
					let aStream = localVideo.captureStream();
					var ctx, source, dest;	
					aStream.onactive = function(){
						var audioContext;
						var audioSource;
						var dest;

						if (SOURCE_ELEMENT_NODES.has(localVideo)) {
							audioSource = SOURCE_ELEMENT_NODES.get(localVideo);
							dest = DEST_ELEMENT_NODES.get(localVideo);
							audioSource.disconnect(dest);
							audioSource.connect(dest);
						} else {
							audioContext = new (window.AudioContext || window.webkitAudioContext)();
							audioSource = audioContext.createMediaElementSource(localVideo);
							dest = audioContext.createMediaStreamDestination();
							audioSource.connect(dest);
							SOURCE_ELEMENT_NODES.set(localVideo, audioSource);
							DEST_ELEMENT_NODES.set(localVideo, dest);
						}

						//console.log(SOURCE_ELEMENT_NODES);						
						//console.log(DEST_ELEMENT_NODES);

						let bStream = dest.stream;

						let videoTrack = aStream.getVideoTracks()[0];
						console.log('videoTrack', videoTrack);
						let audioTrack = bStream.getAudioTracks()[0];
						audioTrack.onended = function() {alert('ฮ่วย!!');}
						console.log('audioTrack', audioTrack);

						console.log('localStream before add Tracks', localStream.getTracks());
						localStream.addTrack(videoTrack);
						localStream.addTrack(audioTrack);
						console.log('localStream after add Tracks', localStream.getTracks());
						
						localStream.onended = function() {
							let event = new CustomEvent("SwithBackMain", { "detail": {}});
							document.dispatchEvent(event);
							localStream.onended = null;
						};

						doReMixStream();
						setTimeout(() => {
							doUpdateStream(mixedStream);
						}, 2500);

						aStream.onactive = null;
					};
					
					localVideo.oncanplay = null;
				};
				*/

</script>